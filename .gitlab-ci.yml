image: python:3.12.0b2-slim-buster

before_script:
  - apt-get update
  - apt-get install -y sshpass
  - apt-get install -y git

stages:
  - report
  - git

cernprod:
  stage: report
  script:
    - python3 gridspace.py --rse CERN-PROD_PHYS-EXOTICS
  artifacts:
    paths:
      - ./reports/CERN-PROD_PHYS-EXOTICS.csv
    expire_in: 24h

cdm:
  stage: report
  script:
    - python3 eos.py -s cdm
  artifacts:
    paths:
      - ./reports/cdm.csv
    expire_in: 24h

hqt:
  stage: report
  script:
    - python3 eos.py -s hqt
  artifacts:
    paths:
      - ./reports/hqt.csv
    expire_in: 24h

jdm:
  stage: report
  script:
    - python3 eos.py -s jdm
  artifacts:
    paths:
      - ./reports/jdm.csv
    expire_in: 24h

lpx:
  stage: report
  script:
    - python3 eos.py -s lpx
  artifacts:
    paths:
      - ./reports/lpx.csv
    expire_in: 24h

ueh:
  stage: report
  script:
    - python3 eos.py -s ueh
  artifacts:
    paths:
      - ./reports/ueh.csv
    expire_in: 24h

git:
  stage: git
  script:
    - git config user.email "exotics.diskspace.watcher@cern.ch"
    - git config user.name "ExoticsDiskspaceWatcher"
    - git remote add gitlab_origin https://oauth2:$ACCESS_TOKEN@gitlab.cern.ch/vaustrup/exoticsdiskspaceusage.git
    - git add reports/*.csv
    # commit and push only if changes present
    # https://stackoverflow.com/questions/22040113/how-to-let-jenkins-git-commit-only-if-there-are-changes
    - git diff --staged --quiet || (git commit -m "update subgroup data" && git push -o ci.skip gitlab_origin HEAD:main)
